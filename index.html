<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Java Prep">
<meta name="theme-color" content="#0f172a">
<meta name="description" content="Senior Java Backend Interview Preparation ‚Äî 13 Modules">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<title>Java Interview Prep</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/protobuf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/graphql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="content.js"></script>
<style>
:root {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --bg-card: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --accent-glow: rgba(59, 130, 246, 0.12);
  --green: #22c55e;
  --green-bg: rgba(34, 197, 94, 0.08);
  --green-border: rgba(34, 197, 94, 0.3);
  --teal: #14b8a6;
  --teal-bg: rgba(20, 184, 166, 0.08);
  --teal-border: rgba(20, 184, 166, 0.3);
  --orange: #f59e0b;
  --orange-bg: rgba(245, 158, 11, 0.08);
  --orange-border: rgba(245, 158, 11, 0.3);
  --purple: #a855f7;
  --purple-bg: rgba(168, 85, 247, 0.08);
  --purple-border: rgba(168, 85, 247, 0.3);
  --red: #ef4444;
  --border: #334155;
  --radius: 10px;
  --shadow: 0 4px 20px rgba(0,0,0,0.3);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
.light {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-tertiary: #e2e8f0;
  --bg-card: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --accent-glow: rgba(59, 130, 246, 0.06);
  --shadow: 0 4px 20px rgba(0,0,0,0.06);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.7;
  overflow: hidden;
  height: 100vh;
  height: 100dvh;
}

/* ===== BOTTOM NAV (Mobile-first) ===== */
.bottom-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0;
  height: calc(56px + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  z-index: 100;
  justify-content: space-around; align-items: center;
}
.bottom-nav .nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 6px 12px; border-radius: 8px; cursor: pointer;
  font-size: 10px; color: var(--text-muted); transition: all 0.15s;
  background: none; border: none; font-family: inherit;
}
.bottom-nav .nav-item.active { color: var(--accent); }
.bottom-nav .nav-item .nav-icon { font-size: 20px; }

/* ===== TOPBAR ===== */
.topbar {
  position: fixed; top: 0; left: 0; right: 0;
  height: calc(56px + var(--safe-top));
  padding-top: var(--safe-top);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding-left: 16px; padding-right: 16px;
  z-index: 100;
}
.topbar-left { display: flex; align-items: center; gap: 12px; }
.menu-btn {
  background: none; border: none; color: var(--text-primary);
  font-size: 22px; cursor: pointer; padding: 6px; border-radius: 8px;
  display: none;
}
.menu-btn:hover { background: var(--bg-tertiary); }
.logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 16px; }
.logo-icon {
  width: 34px; height: 34px; background: linear-gradient(135deg, var(--accent), var(--purple));
  border-radius: 9px; display: flex; align-items: center; justify-content: center;
  font-size: 17px; color: white;
}
.topbar-center { flex: 1; max-width: 460px; margin: 0 16px; }
.search-box {
  width: 100%; padding: 8px 14px 8px 36px;
  background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-primary); font-size: 14px;
  outline: none; transition: border 0.2s;
}
.search-box:focus { border-color: var(--accent); }
.search-wrap { position: relative; }
.search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 15px; pointer-events: none;
}
.topbar-right { display: flex; align-items: center; gap: 8px; }
.theme-toggle {
  background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 12px; cursor: pointer;
  color: var(--text-secondary); font-size: 13px; font-weight: 500;
  transition: all 0.2s; white-space: nowrap;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }
.progress-badge {
  background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 12px;
  color: var(--text-secondary); font-size: 13px; font-weight: 500;
  display: flex; align-items: center; gap: 6px; white-space: nowrap;
}
.progress-badge .bar {
  width: 60px; height: 5px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;
}
.progress-badge .bar-fill {
  height: 100%; background: var(--green); border-radius: 3px; transition: width 0.4s ease;
}

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed; top: calc(56px + var(--safe-top)); left: 0; bottom: 0;
  width: 280px; background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  overflow-y: auto; z-index: 90;
  transition: transform 0.3s ease;
  scrollbar-width: thin; scrollbar-color: var(--bg-tertiary) transparent;
  -webkit-overflow-scrolling: touch;
}
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 2px; }
.sidebar-section { padding: 12px 10px 8px; }
.sidebar-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text-muted); font-weight: 700; padding: 0 8px; margin-bottom: 6px;
}
.module-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 10px; border-radius: 8px; cursor: pointer;
  transition: all 0.15s; margin-bottom: 1px; user-select: none;
}
.module-item:hover { background: var(--accent-glow); }
.module-item.active { background: var(--accent-glow); color: var(--accent); }
.module-num {
  width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0;
  background: var(--bg-tertiary); color: var(--text-secondary);
  transition: all 0.15s;
}
.module-item.active .module-num { background: var(--accent); color: white; }
.module-item.completed .module-num { background: var(--green); color: white; }
.module-name {
  font-size: 13px; font-weight: 500; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; flex: 1;
}
.module-check {
  width: 20px; height: 20px; border-radius: 5px; border: 2px solid var(--border);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; flex-shrink: 0; font-size: 11px; color: transparent;
}
.module-check.checked { background: var(--green); border-color: var(--green); color: white; }
.module-check:hover { border-color: var(--green); }

/* Subtopics */
.subtopics { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 16px; }
.subtopics.open { max-height: 3000px; }
.sub-item {
  padding: 5px 10px; font-size: 12px; color: var(--text-muted);
  cursor: pointer; border-radius: 6px; margin: 1px 0;
  transition: all 0.15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.sub-item:hover { background: var(--bg-tertiary); color: var(--text-secondary); }
.sub-item.active { color: var(--accent); background: var(--accent-glow); }

/* ===== MAIN CONTENT ===== */
.main {
  margin-left: 280px;
  margin-top: calc(56px + var(--safe-top));
  height: calc(100vh - 56px - var(--safe-top));
  height: calc(100dvh - 56px - var(--safe-top));
  overflow-y: auto; padding: 24px 40px 80px;
  -webkit-overflow-scrolling: touch;
}
.main::-webkit-scrollbar { width: 6px; }
.main::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 3px; }

/* ===== HOME SCREEN ===== */
.home-screen { padding: 16px 0; }
.home-header {
  text-align: center; margin-bottom: 28px;
}
.home-header h1 {
  font-size: 28px; font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  margin-bottom: 6px; line-height: 1.3;
}
.home-header p { font-size: 14px; color: var(--text-muted); }
.stats-row {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px;
}
.stat-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px; text-align: center;
}
.stat-card .stat-num { font-size: 28px; font-weight: 800; color: var(--accent); }
.stat-card .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.module-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px;
}
.module-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: 12px; padding: 18px; cursor: pointer;
  transition: all 0.2s; position: relative; overflow: hidden;
}
.module-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
.module-card .mc-num {
  font-size: 11px; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;
}
.module-card .mc-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
.module-card .mc-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
.module-card .mc-icon {
  position: absolute; top: 14px; right: 16px; font-size: 28px; opacity: 0.6;
}
.module-card .mc-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px;
  font-weight: 600; margin-top: 8px;
}
.mc-badge.done { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.mc-badge.todo { background: var(--bg-tertiary); color: var(--text-muted); }

/* ===== CONTENT STYLES ===== */
.content-area { max-width: 860px; margin: 0 auto; display: none; }
.content-area.visible { display: block; animation: fadeIn 0.25s ease; }

/* Nav between modules */
.module-nav {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border);
}
.nav-btn {
  padding: 10px 20px; border-radius: 8px;
  background: var(--bg-secondary); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer;
  font-size: 13px; font-weight: 500; transition: all 0.2s;
}
.nav-btn:hover { border-color: var(--accent); color: var(--accent); }
.nav-btn:disabled { opacity: 0.3; cursor: default; }
.nav-btn:disabled:hover { border-color: var(--border); color: var(--text-secondary); }

.content-area h1 {
  font-size: 28px; font-weight: 800; margin: 40px 0 14px;
  padding-bottom: 10px; border-bottom: 2px solid var(--border);
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.content-area h1:first-child { margin-top: 0; }
.content-area h2 {
  font-size: 20px; font-weight: 700; color: var(--accent);
  margin: 30px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
}
.content-area h3 { font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 20px 0 6px; }
.content-area p { margin: 6px 0 10px; color: var(--text-secondary); font-size: 15px; }
.content-area ul, .content-area ol { margin: 6px 0 14px 20px; color: var(--text-secondary); font-size: 15px; }
.content-area li { margin: 3px 0; }
.content-area strong { color: var(--text-primary); }
.content-area blockquote {
  border-left: 4px solid var(--accent);
  background: var(--accent-glow);
  padding: 14px 18px; margin: 14px 0; border-radius: 0 8px 8px 0;
  color: var(--text-secondary); font-style: italic; font-size: 14px;
}
.content-area pre {
  background: #1a1b26 !important;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 18px;
  margin: 12px 0;
  overflow-x: auto;
  position: relative;
  font-size: 13px;
  line-height: 1.55;
  -webkit-overflow-scrolling: touch;
}
.content-area pre code {
  background: none !important; padding: 0 !important;
  font-family: 'Cascadia Code', 'JetBrains Mono', 'Fira Code', 'Consolas', 'Courier New', monospace;
  font-size: 13px;
}
.content-area code {
  background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;
  font-family: 'Cascadia Code', 'JetBrains Mono', 'Consolas', monospace;
  font-size: 0.87em; color: var(--teal);
}
.copy-btn {
  position: absolute; top: 8px; right: 8px;
  background: var(--bg-tertiary); border: none; color: var(--text-muted);
  padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;
  opacity: 0; transition: opacity 0.2s;
}
.content-area pre:hover .copy-btn { opacity: 1; }
.copy-btn.copied { color: var(--green); }
.content-area table {
  width: 100%; border-collapse: collapse; margin: 14px 0;
  font-size: 13px; border-radius: var(--radius); overflow: hidden;
  display: block; overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.content-area th {
  background: var(--bg-tertiary); color: var(--text-primary);
  padding: 10px 14px; text-align: left; font-weight: 600;
  border-bottom: 2px solid var(--border); white-space: nowrap;
}
.content-area td {
  padding: 8px 14px; border-bottom: 1px solid var(--border);
  color: var(--text-secondary); white-space: nowrap;
}
.content-area tr:hover td { background: var(--accent-glow); }
.content-area hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

/* Special boxes */
.def-box {
  background: var(--teal-bg); border-left: 4px solid var(--teal);
  border-radius: 0 var(--radius) var(--radius) 0;
  padding: 12px 16px; margin: 10px 0;
}
.def-box p { margin: 0; }
.def-box strong { color: var(--teal); }
.plain-box {
  background: var(--green-bg); border-left: 4px solid var(--green);
  border-radius: 0 var(--radius) var(--radius) 0;
  padding: 12px 16px; margin: 10px 0;
}
.plain-box p { margin: 0; }
.plain-box strong { color: var(--green); }
.interview-box {
  background: var(--orange-bg); border-left: 4px solid var(--orange);
  border-radius: 0 var(--radius) var(--radius) 0;
  padding: 12px 16px; margin: 10px 0;
}
.interview-box p { margin: 0; }
.interview-box strong { color: var(--orange); }

/* Search results */
.search-results {
  position: absolute; top: 100%; left: 0; right: 0;
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: 0 0 8px 8px; max-height: 70vh; overflow-y: auto;
  display: none; z-index: 200; box-shadow: var(--shadow);
}
.search-results.show { display: block; }
.search-result-item {
  padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border);
  font-size: 13px; transition: background 0.15s;
}
.search-result-item:hover, .search-result-item:active { background: var(--accent-glow); }
.sr-module { font-size: 10px; color: var(--accent); font-weight: 700; text-transform: uppercase; }
.sr-title { font-size: 13px; color: var(--text-primary); font-weight: 500; margin-top: 1px; }
.sr-snippet { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.sr-snippet mark { background: var(--orange); color: #000; border-radius: 2px; padding: 0 2px; }

/* Scroll to top */
.scroll-top {
  position: fixed; bottom: 24px; right: 20px; width: 42px; height: 42px;
  border-radius: 50%; background: var(--accent); color: white; border: none;
  font-size: 18px; cursor: pointer; display: none; align-items: center;
  justify-content: center; box-shadow: var(--shadow); z-index: 50;
  transition: transform 0.2s;
}
.scroll-top:hover { transform: translateY(-2px); }
.scroll-top.show { display: flex; }

/* Overlay */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 85; }
.overlay.show { display: block; }

/* ===== MOBILE ===== */
@media (max-width: 768px) {
  .sidebar { width: 280px; transform: translateX(-100%); z-index: 200; bottom: 0; }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; padding: 16px 14px 80px; height: calc(100dvh - 56px - 56px - var(--safe-top) - var(--safe-bottom)); }
  .menu-btn { display: block; }
  .topbar-center { margin: 0 8px; }
  .search-box { font-size: 16px; padding: 8px 12px 8px 32px; /* prevent zoom */ }
  .bottom-nav { display: flex; }
  .scroll-top { bottom: 72px; right: 14px; }
  .home-header h1 { font-size: 22px; }
  .stats-row { grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .stat-card .stat-num { font-size: 22px; }
  .module-grid { grid-template-columns: 1fr; }
  .content-area h1 { font-size: 22px; }
  .content-area h2 { font-size: 18px; }
  .content-area pre { font-size: 12px; padding: 12px 14px; }
  .progress-badge { display: none; }
  .theme-toggle { padding: 6px 8px; font-size: 12px; }
}
@media (min-width: 769px) {
  .bottom-nav { display: none !important; }
  .menu-btn { display: none; }
}

/* Print */
@media print {
  .sidebar, .topbar, .scroll-top, .copy-btn, .module-check, .bottom-nav, .overlay, .module-nav { display: none !important; }
  .main { margin: 0; padding: 20px; overflow: visible; height: auto; }
  body { overflow: visible; }
  .content-area pre { white-space: pre-wrap; }
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>

<!-- Topbar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="menu-btn" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
    <div class="logo" onclick="goHome()" style="cursor:pointer" title="Home">
      <div class="logo-icon">‚òï</div>
      <span class="logo-text">Java Prep</span>
    </div>
  </div>
  <div class="topbar-center">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-box" placeholder="Search..." id="searchInput" autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>
  </div>
  <div class="topbar-right">
    <div class="progress-badge">
      <span id="progressText">0/13</span>
      <div class="bar"><div class="bar-fill" id="progressBar" style="width:0%"></div></div>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
  </div>
</header>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-label">Modules</div>
    <div id="moduleList"></div>
  </div>
</nav>
<div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>

<!-- Main -->
<main class="main" id="mainContent">
  <div class="home-screen" id="homeScreen"></div>
  <div class="content-area" id="contentArea"></div>
</main>

<!-- Bottom Nav (mobile) -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="goHome()" id="bnHome">
    <span class="nav-icon">üè†</span>Home
  </button>
  <button class="nav-item" onclick="toggleSidebar(true)" id="bnModules">
    <span class="nav-icon">üìö</span>Modules
  </button>
  <button class="nav-item" onclick="focusSearch()" id="bnSearch">
    <span class="nav-icon">üîç</span>Search
  </button>
  <button class="nav-item" onclick="toggleTheme()" id="bnTheme">
    <span class="nav-icon">üåô</span>Theme
  </button>
</nav>

<!-- Scroll to top -->
<button class="scroll-top" id="scrollTop" onclick="scrollToTop()">‚Üë</button>

<script>
// ===== STATE =====
let modules = [];
let activeModuleIndex = -1;
let completedModules = JSON.parse(localStorage.getItem('jprep_completed') || '{}');
let isDark = localStorage.getItem('jprep_theme') !== 'light';
let allSections = [];
let lastScroll = JSON.parse(localStorage.getItem('jprep_scroll') || '{}');

const MODULE_ICONS = ['‚òï','üß†','üå±','üèóÔ∏è','üóÑÔ∏è','üì®','üîå','üê≥','üìê','üß©','üìä','ü§ñ','üé§','üéì'];
const MODULE_DESCS = [
  'Records, sealed classes, virtual threads, pattern matching, text blocks, var',
  'JVM internals, GC algorithms, memory model, classloading, concurrency',
  'javax‚Üíjakarta, SecurityFilterChain, Spring AI, JPA tuning, Actuator',
  'Saga, circuit breaker, outbox, CQRS, event sourcing, DDD',
  'Window functions, PostgreSQL, indexing deep dive, transactions, Redis, pgvector',
  'Architecture, Spring Kafka, delivery guarantees, DLT, performance tuning',
  'REST best practices, pagination, idempotency, gRPC, GraphQL, WebSockets',
  'Docker, Kubernetes, AWS core services, CI/CD pipelines, observability',
  '5-step framework, back-of-envelope math, 10+ real system designs',
  'SOLID principles, Strategy, Builder, Observer, Factory, Singleton, Decorator',
  '13 patterns: two pointers, sliding window, DP, trees, graphs, heap',
  'Spring AI, function calling, embeddings, RAG, pgvector production patterns',
  'STAR method, 90-sec intro, salary negotiation, resume, top 10 questions'
];

// ===== INIT =====
if (!isDark) document.body.classList.add('light');
updateThemeBtn();

marked.setOptions({
  highlight: (code, lang) => {
    if (lang && hljs.getLanguage(lang)) {
      try { return hljs.highlight(code, { language: lang }).value; } catch(e) {}
    }
    try { return hljs.highlightAuto(code).value; } catch(e) {}
    return code;
  },
  breaks: false, gfm: true
});

// Parse content immediately from embedded SYLLABUS_MD
const rawMd = typeof SYLLABUS_MD === 'string' ? SYLLABUS_MD : (SYLLABUS_MD.value || SYLLABUS_MD);
parseContent(rawMd);

function parseContent(markdown) {
  const parts = markdown.split(/(?=^# MODULE \d+)/m);
  modules = [];
  parts.forEach(part => {
    const match = part.match(/^# MODULE (\d+):\s*(.+)/m);
    if (match) {
      const num = parseInt(match[1]);
      const title = match[2].trim();
      const subs = [];
      const subRe = /^## (\d+\.\d+)\s+(.+)/gm;
      let m;
      while ((m = subRe.exec(part)) !== null) subs.push({ id: m[1], title: m[2].trim() });
      modules.push({ num, title, content: part, subtopics: subs });
    }
  });

  // Final summary
  const fin = markdown.match(/# üéì FINAL SUMMARY[\s\S]*$/m);
  if (fin) modules.push({ num: 99, title: 'Final Summary', content: fin[0], subtopics: [] });

  buildSidebar();
  buildSearchIndex();
  renderHome();
}

// ===== HOME SCREEN =====
function renderHome() {
  const done = Object.values(completedModules).filter(Boolean).length;
  const total = modules.filter(m => m.num <= 13).length;
  const topicCount = modules.reduce((s, m) => s + m.subtopics.length, 0);

  let html = `
    <div class="home-header">
      <h1>Senior Java Backend<br>Interview Prep</h1>
      <p>13 modules ¬∑ ${topicCount}+ topics ¬∑ Everything you need</p>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-num">${total}</div><div class="stat-label">Modules</div></div>
      <div class="stat-card"><div class="stat-num">${done}</div><div class="stat-label">Completed</div></div>
      <div class="stat-card"><div class="stat-num">${total > 0 ? Math.round(done/total*100) : 0}%</div><div class="stat-label">Progress</div></div>
    </div>
    <div class="module-grid">`;

  modules.forEach((mod, idx) => {
    if (mod.num > 13) return;
    const isDone = completedModules[mod.num];
    html += `
      <div class="module-card" onclick="showModule(${idx})">
        <div class="mc-icon">${MODULE_ICONS[idx] || 'üìñ'}</div>
        <div class="mc-num">Module ${mod.num}</div>
        <div class="mc-title">${mod.title}</div>
        <div class="mc-desc">${MODULE_DESCS[idx] || ''}</div>
        <span class="mc-badge ${isDone ? 'done' : 'todo'}">${isDone ? '‚úì Completed' : mod.subtopics.length + ' topics'}</span>
      </div>`;
  });

  // Final summary card
  const finIdx = modules.findIndex(m => m.num === 99);
  if (finIdx >= 0) {
    html += `
      <div class="module-card" onclick="showModule(${finIdx})" style="border-color:var(--purple-border)">
        <div class="mc-icon">üéì</div>
        <div class="mc-num" style="color:var(--purple)">Summary</div>
        <div class="mc-title">Final Summary Table</div>
        <div class="mc-desc">Quick reference of all 13 modules in one table</div>
      </div>`;
  }

  html += '</div>';
  document.getElementById('homeScreen').innerHTML = html;
}

function goHome() {
  activeModuleIndex = -1;
  document.getElementById('contentArea').classList.remove('visible');
  document.getElementById('contentArea').innerHTML = '';
  document.getElementById('homeScreen').style.display = '';
  document.querySelectorAll('.module-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.subtopics').forEach(el => el.classList.remove('open'));
  document.querySelectorAll('.bottom-nav .nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('bnHome').classList.add('active');
  document.getElementById('mainContent').scrollTop = 0;
  if (window.innerWidth <= 768) toggleSidebar(false);
}

// ===== SIDEBAR =====
function buildSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = '';
  modules.forEach((mod, idx) => {
    const wrapper = document.createElement('div');
    const item = document.createElement('div');
    item.className = 'module-item' + (completedModules[mod.num] ? ' completed' : '');
    item.dataset.index = idx;
    item.innerHTML = `
      <div class="module-num">${mod.num <= 13 ? mod.num : '‚òÖ'}</div>
      <div class="module-name">${MODULE_ICONS[idx] || 'üìñ'} ${mod.title}</div>
      ${mod.num <= 13 ? `<div class="module-check ${completedModules[mod.num] ? 'checked' : ''}" data-mod="${mod.num}" title="Mark complete">‚úì</div>` : ''}`;
    item.addEventListener('click', e => {
      if (e.target.closest('.module-check')) return;
      showModule(idx);
    });
    const check = item.querySelector('.module-check');
    if (check) {
      check.addEventListener('click', e => {
        e.stopPropagation();
        completedModules[check.dataset.mod] = !completedModules[check.dataset.mod];
        localStorage.setItem('jprep_completed', JSON.stringify(completedModules));
        check.classList.toggle('checked');
        item.classList.toggle('completed');
        updateProgress();
        renderHome();
      });
    }
    wrapper.appendChild(item);
    if (mod.subtopics.length) {
      const subDiv = document.createElement('div');
      subDiv.className = 'subtopics';
      subDiv.dataset.moduleIndex = idx;
      mod.subtopics.forEach(sub => {
        const si = document.createElement('div');
        si.className = 'sub-item';
        si.textContent = sub.id + ' ' + sub.title;
        si.addEventListener('click', () => {
          showModule(idx);
          setTimeout(() => {
            const el = document.getElementById('section-' + sub.id.replace('.', '-'));
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 50);
        });
        subDiv.appendChild(si);
      });
      wrapper.appendChild(subDiv);
    }
    list.appendChild(wrapper);
  });
  updateProgress();
}

function showModule(index) {
  activeModuleIndex = index;
  const mod = modules[index];

  // Update UI state
  document.getElementById('homeScreen').style.display = 'none';
  document.querySelectorAll('.module-item').forEach((el, i) => el.classList.toggle('active', i === index));
  document.querySelectorAll('.subtopics').forEach(el => el.classList.toggle('open', parseInt(el.dataset.moduleIndex) === index));
  document.querySelectorAll('.bottom-nav .nav-item').forEach(el => el.classList.remove('active'));

  // Render markdown
  let html = marked.parse(mod.content);
  html = html.replace(/<h2[^>]*>([\s\S]*?)<\/h2>/g, (match, inner) => {
    const numMatch = inner.match(/(\d+\.\d+)/);
    if (numMatch) return `<h2 id="section-${numMatch[1].replace('.', '-')}">${inner}</h2>`;
    return match;
  });
  html = postProcess(html);

  // Add prev/next nav
  html += `<div class="module-nav">
    <button class="nav-btn" onclick="navModule(-1)" ${index === 0 ? 'disabled' : ''}>‚Üê Previous</button>
    <button class="nav-btn" onclick="goHome()">üè† Home</button>
    <button class="nav-btn" onclick="navModule(1)" ${index === modules.length - 1 ? 'disabled' : ''}>Next ‚Üí</button>
  </div>`;

  const ca = document.getElementById('contentArea');
  ca.innerHTML = html;
  ca.classList.add('visible');

  // Copy buttons
  ca.querySelectorAll('pre').forEach(pre => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.addEventListener('click', () => {
      navigator.clipboard.writeText(pre.querySelector('code')?.textContent || pre.textContent).then(() => {
        btn.textContent = '‚úì Copied'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
      });
    });
    pre.appendChild(btn);
  });

  // Mobile: always show copy on touch devices
  if ('ontouchstart' in window) {
    ca.querySelectorAll('.copy-btn').forEach(b => b.style.opacity = '0.6');
  }

  document.getElementById('mainContent').scrollTop = lastScroll[index] || 0;
  if (window.innerWidth <= 768) toggleSidebar(false);
}

function navModule(dir) {
  const next = activeModuleIndex + dir;
  if (next >= 0 && next < modules.length) showModule(next);
}

// Save scroll position
document.getElementById('mainContent').addEventListener('scroll', () => {
  if (activeModuleIndex >= 0) {
    lastScroll[activeModuleIndex] = document.getElementById('mainContent').scrollTop;
    localStorage.setItem('jprep_scroll', JSON.stringify(lastScroll));
  }
  document.getElementById('scrollTop').classList.toggle('show', document.getElementById('mainContent').scrollTop > 300);
});

function postProcess(html) {
  html = html.replace(/<p>(<strong>Definition:<\/strong>[\s\S]*?)<\/p>/g, '<div class="def-box"><p>$1</p></div>');
  html = html.replace(/<p>(<strong>In [Pp]lain English:<\/strong>[\s\S]*?)<\/p>/g, '<div class="plain-box"><p>$1</p></div>');
  html = html.replace(/<p>(<strong>Interview Q[\s\S]*?<\/strong>[\s\S]*?)<\/p>/g, '<div class="interview-box"><p>$1</p></div>');
  html = html.replace(/<p>(<strong>When to use:<\/strong>[\s\S]*?)<\/p>/g, '<div class="plain-box"><p>$1</p></div>');
  html = html.replace(/<p>(<strong>Trade-off:<\/strong>[\s\S]*?)<\/p>/g, '<div class="interview-box"><p>$1</p></div>');
  html = html.replace(/<p>(<strong>Why RAG\?<\/strong>[\s\S]*?)<\/p>/g, '<div class="plain-box"><p>$1</p></div>');
  return html;
}

// ===== SEARCH =====
function buildSearchIndex() {
  allSections = [];
  modules.forEach((mod, idx) => {
    const parts = mod.content.split(/(?=^## )/m);
    parts.forEach(part => {
      const t = part.match(/^##\s+(.+)/m);
      allSections.push({
        mi: idx, num: mod.num, mt: mod.title,
        st: t ? t[1].trim() : 'Introduction',
        text: part.replace(/```[\s\S]*?```/g, '').replace(/[#*`|]/g, '').substring(0, 600)
      });
    });
  });
}

const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
let searchTimer;

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => doSearch(searchInput.value), 150);
});
searchInput.addEventListener('focus', () => { if (searchInput.value.length >= 2) doSearch(searchInput.value); });
document.addEventListener('click', e => { if (!e.target.closest('.search-wrap')) searchResults.classList.remove('show'); });
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); searchInput.focus(); }
  if (e.key === 'Escape') { searchResults.classList.remove('show'); searchInput.blur(); }
});

function focusSearch() { searchInput.focus(); }

function doSearch(q) {
  if (q.length < 2) { searchResults.classList.remove('show'); return; }
  const lower = q.toLowerCase();
  const res = allSections.filter(s => s.text.toLowerCase().includes(lower) || s.st.toLowerCase().includes(lower)).slice(0, 12);
  if (!res.length) {
    searchResults.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">No results</div>';
  } else {
    searchResults.innerHTML = res.map(r => {
      const pos = r.text.toLowerCase().indexOf(lower);
      let snippet = '';
      if (pos >= 0) {
        const s = Math.max(0, pos - 30), e = Math.min(r.text.length, pos + q.length + 50);
        snippet = (s > 0 ? '...' : '') + r.text.substring(s, pos) + '<mark>' + r.text.substring(pos, pos + q.length) + '</mark>' + r.text.substring(pos + q.length, e) + (e < r.text.length ? '...' : '');
      } else { snippet = r.text.substring(0, 80) + '...'; }
      return `<div class="search-result-item" data-mi="${r.mi}">
        <div class="sr-module">Module ${r.num}: ${r.mt}</div>
        <div class="sr-title">${r.st}</div>
        <div class="sr-snippet">${snippet}</div>
      </div>`;
    }).join('');
  }
  searchResults.classList.add('show');
  searchResults.querySelectorAll('.search-result-item[data-mi]').forEach(el => {
    el.addEventListener('click', () => {
      showModule(parseInt(el.dataset.mi));
      searchResults.classList.remove('show');
      searchInput.value = '';
    });
  });
}

// ===== PROGRESS =====
function updateProgress() {
  const total = modules.filter(m => m.num <= 13).length;
  const done = Object.keys(completedModules).filter(k => completedModules[k] && parseInt(k) <= 13).length;
  document.getElementById('progressText').textContent = `${done}/${total}`;
  document.getElementById('progressBar').style.width = (total ? Math.round(done / total * 100) : 0) + '%';
}

// ===== THEME =====
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  localStorage.setItem('jprep_theme', isDark ? 'dark' : 'light');
  updateThemeBtn();
}
function updateThemeBtn() {
  document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

// ===== SIDEBAR TOGGLE =====
function toggleSidebar(force) {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('overlay');
  const isOpen = force !== undefined ? force : !sb.classList.contains('open');
  sb.classList.toggle('open', isOpen);
  ov.classList.toggle('show', isOpen);
}

function scrollToTop() { document.getElementById('mainContent').scrollTo({ top: 0, behavior: 'smooth' }); }

// ===== PWA SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW:', err));
  });
}

// ===== INSTALL PROMPT =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Show install banner on home screen
  const banner = document.createElement('div');
  banner.style.cssText = 'background:var(--accent);color:white;padding:12px 20px;border-radius:12px;text-align:center;margin-bottom:16px;cursor:pointer;font-weight:600;font-size:14px;';
  banner.textContent = 'üì≤ Install this app on your device';
  banner.addEventListener('click', () => {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; banner.remove(); });
  });
  const home = document.getElementById('homeScreen');
  if (home.firstChild) home.insertBefore(banner, home.firstChild);
});
</script>
</body>
</html>
